<ManagementPack ContentReadable="true" SchemaVersion="2.0" OriginalSchemaVersion="1.1" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
  <Manifest>
    <Identity>
      <ID>Custom.SM.OfficeToAssignmentGroup.Workflows.MP</ID>
      <Version>1.0.0.5</Version>
    </Identity>
    <Name>Custom.SM.OfficeToAssignmentGroup.Workflows.MP</Name>
    <References>
      <Reference Alias="System">
        <ID>System.Library</ID>
        <Version>7.5.8501.0</Version>
        <PublicKeyToken>31bf3856ad364e35</PublicKeyToken>
      </Reference>
      <Reference Alias="Console">
        <ID>Microsoft.EnterpriseManagement.ServiceManager.UI.Console</ID>
        <Version>7.5.3079.0</Version>
        <PublicKeyToken>31bf3856ad364e35</PublicKeyToken>
      </Reference>
      <Reference Alias="CustomSystem_WorkItem_ServiceRequest_Library">
        <ID>System.WorkItem.ServiceRequest.Library</ID>
        <Version>7.5.3079.0</Version>
        <PublicKeyToken>31bf3856ad364e35</PublicKeyToken>
      </Reference>
      <Reference Alias="EnterpriseManagement">
        <ID>Microsoft.EnterpriseManagement.ServiceManager.UI.Administration</ID>
        <Version>7.5.3079.0</Version>
        <PublicKeyToken>31bf3856ad364e35</PublicKeyToken>
      </Reference>
      <Reference Alias="SystemCenter">
        <ID>Microsoft.SystemCenter.Library</ID>
        <Version>7.0.8433.0</Version>
        <PublicKeyToken>31bf3856ad364e35</PublicKeyToken>
      </Reference>
      <Reference Alias="SystemCenter1">
        <ID>Microsoft.SystemCenter.Subscriptions</ID>
        <Version>7.5.3079.0</Version>
        <PublicKeyToken>31bf3856ad364e35</PublicKeyToken>
      </Reference>
      <Reference Alias="Core">
        <ID>ServiceManager.Core.Library</ID>
        <Version>7.5.3079.0</Version>
        <PublicKeyToken>31bf3856ad364e35</PublicKeyToken>
      </Reference>
      <Reference Alias="Windows">
        <ID>Microsoft.Windows.Library</ID>
        <Version>7.5.8501.0</Version>
        <PublicKeyToken>31bf3856ad364e35</PublicKeyToken>
      </Reference>
      <Reference Alias="CustomSystem_WorkItem_Incident_Library">
        <ID>System.WorkItem.Incident.Library</ID>
        <Version>7.5.3079.0</Version>
        <PublicKeyToken>31bf3856ad364e35</PublicKeyToken>
      </Reference>
    </References>
  </Manifest>
  <TypeDefinitions>
    <ModuleTypes>
      <WriteActionModuleType ID="OfficeToAssignmentGroupSRWF.WindowsPowerShellScript.64d30824_573f_4eab_8e10_936864f78bb8.MT" Accessibility="Public" RunAs="Core!Microsoft.SystemCenter.ServiceManager.WorkflowAccount" Batching="false">
        <Configuration>
          <IncludeSchemaTypes>
            <SchemaType>Windows!Microsoft.Windows.PowerShellSchema</SchemaType>
          </IncludeSchemaTypes>
          <xsd:element name="GUID" type="xsd:string" xmlns:xsd="http://www.w3.org/2001/XMLSchema" />
        </Configuration>
        <OverrideableParameters>
          <OverrideableParameter ID="GUID" Selector="$Config/GUID$" ParameterType="string" />
        </OverrideableParameters>
        <ModuleImplementation Isolation="Any">
          <Composite>
            <MemberModules>
              <WriteAction ID="OfficeToAssignmentGroupSRWF.WindowsPowerShellScript.64d30824_573f_4eab_8e10_936864f78bb8.PSWA" TypeID="Windows!Microsoft.Windows.PowerShellWriteAction">
                <ScriptName>DoWork.ps1</ScriptName>
                <ScriptBody>param ( [string]$GUID )
get-module|Remove-Module -force
Set-PSDebug -Strict
[threading.thread]::CurrentThread.CurrentCulture = 'en-US'
$Global:Log = ""
function Log($Message){
    if($Global:Log -eq ""){
        New-EventLog -LogName 'Operations Manager' -Source 'Custom' -ErrorAction SilentlyContinue
        $Global:Log = "$Message`r`n"
    } else {
        $Global:Log += "$Message`r`n"
    } 
    Write-Output $Message
}
function TryDefault($Ticket,$Mappings,$TierItems){
     $Item = $Items|?{$_.DisplayName -eq 'Default'}
            if($Item -ne $null){
                $Defaults = Get-SCSMChildEnumeration -Depth OneLevel -Enumeration $Item
                $Target = $null
                foreach($Default in $Defaults){
                    if($Target -eq $null){
                        $Target = $TierItems|?{$_.DisplayName -eq $Default.DisplayName}
                    } else { break;}
                }

                Log "Default mapping found: '$($Target.DisplayName)'"
                Set-SCSMObject -SMObject $Ticket -PropertyHashtable @{'SupportGroup'=$Target.DisplayName} 
                Log "Ticket Support Group Set to $($Target.DisplayName)"
            } else { Log "No default mapping found"} 
}
try{
    Import-Module smlets -Force -Global
    Log 'Office To Assignment Group Workflow (SR) Started'
    
    # $GUID = '734f814c-464a-5936-9184-51316f40fdeb'
    Log "Ticket GUID: $GUID"
    $Ticket = Get-SCSMObject -Id $GUID
    Log "Ticket ID: $($Ticket.Name)"
    $UserClass = Get-SCSMClass -Name 'System.Domain.User'

    $Relationship = Get-SCSMRelationshipClass -Name 'System.WorkItemAffectedUser'

    $AffectedUser = Get-SCSMRelatedObject -SMObject $Ticket -Relationship $Relationship
     $ConfigList = Get-SCSMTopLevelEnumeration -Name 'Custom.SM.OfficeToAssignmentGroup.MP.ENUM_Mapping'
     $Items = Get-SCSMChildEnumeration -Depth 0 -Enumeration $ConfigList
    if($AffectedUser -ne $null){
        Log "Affected User: $($AffectedUser.DisplayName) with Office '$($AffectedUser.Office)'"
       
        $Item = $null
        $Item = $Items|?{$_.DisplayName -eq $AffectedUser.Office}
        if($Item -ne $null){
            $SubItems = Get-SCSMChildEnumeration -Depth OneLevel -Enumeration $Item
            $TierList = Get-SCSMTopLevelEnumeration -Name 'ServiceRequestSupportGroupEnum'
            $TierItems = Get-SCSMChildEnumeration -Depth Recursive -Enumeration $TierList
            $Target = $null
            foreach($SubItem in $SubItems){
     
                if($Target -eq $null){
    
                    $Target = $TierItems|?{$_.DisplayName -eq $SubItem.DisplayName}
                } else {break;}
            }
    
            if($Target -ne $null){
                Log "Mapping found: $($Item.DisplayName) --&gt; $($Target.DisplayName)"

                Set-SCSMObject -SMObject $Ticket -PropertyHashtable @{'SupportGroup'=$Target.DisplayName}
                Log "Ticket Support Group Set to $($Target.DisplayName)"
            } else {
                Log "No mapping found"
                TryDefault $Ticket $Items $TierItems
            }
        } else { 
            Log "No mapping found"
            TryDefault $Ticket $Items $TierItems
        }
    } else { Log "No affected user found";TryDefault $Ticket $Items $TierItems}
} catch {
    Log "Error: $_"
} finally {
    Log "Workflow ended"
    Write-EventLog -LogName 'Operations Manager' -Source 'Custom' -EntryType Information -Message $Global:Log -EventId 0

    Get-Module|Remove-Module -Force
    
}</ScriptBody>
                <SnapIns></SnapIns>
                <Parameters>
                  <Parameter>
                    <Name>GUID</Name>
                    <Value>$Config/GUID$</Value>
                  </Parameter>
                </Parameters>
                <TimeoutSeconds>300</TimeoutSeconds>
                <StrictErrorHandling>true</StrictErrorHandling>
                <SerializationDepth>3</SerializationDepth>
              </WriteAction>
            </MemberModules>
            <Composition>
              <Node ID="OfficeToAssignmentGroupSRWF.WindowsPowerShellScript.64d30824_573f_4eab_8e10_936864f78bb8.PSWA" />
            </Composition>
          </Composite>
        </ModuleImplementation>
        <InputType>System!System.BaseData</InputType>
      </WriteActionModuleType>
      <WriteActionModuleType ID="OfficeToAssignmentGroupIRWF.WindowsPowerShellScript.1cc6771d_2022_4891_b61c_797ce410c8b0.MT" Accessibility="Public" RunAs="Core!Microsoft.SystemCenter.ServiceManager.WorkflowAccount" Batching="false">
        <Configuration>
          <IncludeSchemaTypes>
            <SchemaType>Windows!Microsoft.Windows.PowerShellSchema</SchemaType>
          </IncludeSchemaTypes>
          <xsd:element name="GUID" type="xsd:string" xmlns:xsd="http://www.w3.org/2001/XMLSchema" />
        </Configuration>
        <OverrideableParameters>
          <OverrideableParameter ID="GUID" Selector="$Config/GUID$" ParameterType="string" />
        </OverrideableParameters>
        <ModuleImplementation Isolation="Any">
          <Composite>
            <MemberModules>
              <WriteAction ID="OfficeToAssignmentGroupIRWF.WindowsPowerShellScript.1cc6771d_2022_4891_b61c_797ce410c8b0.PSWA" TypeID="Windows!Microsoft.Windows.PowerShellWriteAction">
                <ScriptName>DoWork.ps1</ScriptName>
                <ScriptBody>param ( [string]$GUID )
get-module|Remove-Module -force
Set-PSDebug -Strict
[threading.thread]::CurrentThread.CurrentCulture = 'en-US'
$Global:Log = ""
function Log($Message){
    if($Global:Log -eq ""){
        New-EventLog -LogName 'Operations Manager' -Source 'Custom' -ErrorAction SilentlyContinue
        $Global:Log = "$Message`r`n"
    } else {
        $Global:Log += "$Message`r`n"
    } 
    Write-Output $Message
}
try{
    Import-Module smlets -Force -Global
    Log 'Office To Assignment Group Workflow (IR) Started'
    $Office = $null
  # $GUID = 'dbc0f104-cf79-e135-7911-3116b03bd454'
    Log "Ticket GUID: $GUID"
    $Ticket = Get-SCSMObject -Id $GUID
    Log "Ticket ID: $($Ticket.Name)"
    $UserClass = Get-SCSMClass -Name 'System.Domain.User'

    $Relationship = Get-SCSMRelationshipClass -Name 'System.WorkItemAffectedUser'

    $AffectedUser = Get-SCSMRelatedObject -SMObject $Ticket -Relationship $Relationship
    if($AffectedUser -ne $null){
        Log "Affected User: $($AffectedUser.DisplayName) with Office '$($AffectedUser.Office)'"
        if(($($AffectedUser.Office) -eq $null) -or ($($AffectedUser.Office -eq ""))){
            $Office = 'Leave Empty'
        } else {
            $Office = ($($AffectedUser.Office))
        }
    } else { Log "No Affected User found, using default Office value";$Office = 'Leave Empty'}
        $ConfigList = Get-SCSMObject -Class (get-scsmclass -name 'custom.sm.officetoassignmentgroup.mp.c_incidentsetting') -Filter "A_Office = '$Office'"
        if($ConfigList -ne $null){
            Log "Found Setting: Office -&gt; $($ConfigList.A_Office), User -&gt; $($ConfigList.A_UserGroupString), Tier -&gt; $($ConfigList.A_TierString)"
            
            if([Guid] $ConfigList.A_Tier -ne [Guid]::Empty){
                $Tier = Get-SCSMEnumeration -id $ConfigList.A_Tier
                Set-SCSMObject -PropertyHashtable @{"TierQueue"=$ConfigList.A_Tier} -SMObject $Ticket

              
            }
            if([Guid] $ConfigList.A_UserGroup -ne [Guid]::Empty){
                 $AssignRelation = Get-SCSMRelationshipClass -name System.WorkItemAssignedToUser$
                 $AssignUser = Get-SCSMObject -Id $ConfigList.A_UserGroup
                 New-SCSMRelationshipObject -Source $Ticket -Relationship $AssignRelation -Target $AssignUser -Bulk
            }
           
           
             
            
            Log "Ticket Updated"
        } else {
            Log "No Setting found"
        }
       
            
       
} catch {
    Log "Error: $_"
} finally {
    Log "Workflow ended"
    Write-EventLog -LogName 'Operations Manager' -Source 'Custom' -EntryType Information -Message $Global:Log -EventId 0

    Get-Module|Remove-Module -Force
    
}</ScriptBody>
                <SnapIns></SnapIns>
                <Parameters>
                  <Parameter>
                    <Name>GUID</Name>
                    <Value>$Config/GUID$</Value>
                  </Parameter>
                </Parameters>
                <TimeoutSeconds>300</TimeoutSeconds>
                <StrictErrorHandling>true</StrictErrorHandling>
                <SerializationDepth>3</SerializationDepth>
              </WriteAction>
            </MemberModules>
            <Composition>
              <Node ID="OfficeToAssignmentGroupIRWF.WindowsPowerShellScript.1cc6771d_2022_4891_b61c_797ce410c8b0.PSWA" />
            </Composition>
          </Composite>
        </ModuleImplementation>
        <InputType>System!System.BaseData</InputType>
      </WriteActionModuleType>
    </ModuleTypes>
  </TypeDefinitions>
  <Categories>
    <Category ID="Custom.SM.OfficeToAssignmentGroup.Workflows.MP.Category" Value="Console!Microsoft.EnterpriseManagement.ServiceManager.ManagementPack">
      <ManagementPackName>Custom.SM.OfficeToAssignmentGroup.Workflows.MP</ManagementPackName>
      <ManagementPackVersion>1.0.0.0</ManagementPackVersion>
    </Category>
    <Category ID="OfficeToAssignmentGroupSRWFCategory" Target="OfficeToAssignmentGroupSRWF" Value="EnterpriseManagement!Microsoft.EnterpriseManagement.ServiceManager.Rules.WorkflowSubscriptions" />
    <Category ID="OfficeToAssignmentGroupIRWFCategory" Target="OfficeToAssignmentGroupIRWF" Value="EnterpriseManagement!Microsoft.EnterpriseManagement.ServiceManager.Rules.WorkflowSubscriptions" />
  </Categories>
  <Monitoring>
    <Rules>
      <Rule ID="OfficeToAssignmentGroupSRWF" Enabled="true" Target="SystemCenter!Microsoft.SystemCenter.SubscriptionWorkflowTarget" ConfirmDelivery="true" Remotable="true" Priority="Normal" DiscardLevel="100">
        <Category>Notification</Category>
        <DataSources>
          <DataSource ID="DS" TypeID="SystemCenter1!Microsoft.SystemCenter.CmdbInstanceSubscription.DataSourceModule">
            <Subscription>
              <InstanceSubscription Type="$MPElement[Name='CustomSystem_WorkItem_ServiceRequest_Library!System.WorkItem.ServiceRequest']$">
                <AddInstance>
                  <Criteria>
                    <Expression>
                      <UnaryExpression>
                        <ValueExpression>
                          <Property State="Post">$Context/Property[Type='CustomSystem_WorkItem_ServiceRequest_Library!System.WorkItem.ServiceRequest']/SupportGroup$</Property>
                        </ValueExpression>
                        <Operator>IsNull</Operator>
                      </UnaryExpression>
                    </Expression>
                  </Criteria>
                </AddInstance>
              </InstanceSubscription>
              <PollingIntervalInSeconds>60</PollingIntervalInSeconds>
              <BatchSize>100</BatchSize>
            </Subscription>
          </DataSource>
        </DataSources>
        <WriteActions>
          <WriteAction ID="WA" TypeID="SystemCenter1!Microsoft.EnterpriseManagement.SystemCenter.Subscription.WindowsWorkflowTaskWriteAction">
            <Subscription>
              <WindowsWorkflowConfiguration>
                <AssemblyName>OfficeToAssignmentGroupSRWF</AssemblyName>
                <WorkflowTypeName>WorkflowAuthoring.OfficeToAssignmentGroupSRWF</WorkflowTypeName>
                <WorkflowParameters>
                  <WorkflowParameter Name="OfficeToAssignmentGroupSRScript_GUID" Type="string">$Data/BaseManagedEntityId$</WorkflowParameter>
                </WorkflowParameters>
                <RetryExceptions></RetryExceptions>
                <RetryDelaySeconds>60</RetryDelaySeconds>
                <MaximumRunningTimeSeconds>300</MaximumRunningTimeSeconds>
              </WindowsWorkflowConfiguration>
            </Subscription>
          </WriteAction>
        </WriteActions>
      </Rule>
      <Rule ID="OfficeToAssignmentGroupIRWF" Enabled="true" Target="SystemCenter!Microsoft.SystemCenter.SubscriptionWorkflowTarget" ConfirmDelivery="true" Remotable="true" Priority="Normal" DiscardLevel="100">
        <Category>Notification</Category>
        <DataSources>
          <DataSource ID="DS" TypeID="SystemCenter1!Microsoft.SystemCenter.CmdbInstanceSubscription.DataSourceModule">
            <Subscription>
              <InstanceSubscription Type="$MPElement[Name='CustomSystem_WorkItem_Incident_Library!System.WorkItem.Incident']$">
                <AddInstance>
                  <Criteria>
                    <Expression>
                      <UnaryExpression>
                        <ValueExpression>
                          <Property State="Post">$Context/Property[Type='CustomSystem_WorkItem_Incident_Library!System.WorkItem.Incident']/TierQueue$</Property>
                        </ValueExpression>
                        <Operator>IsNull</Operator>
                      </UnaryExpression>
                    </Expression>
                  </Criteria>
                </AddInstance>
              </InstanceSubscription>
              <PollingIntervalInSeconds>60</PollingIntervalInSeconds>
              <BatchSize>100</BatchSize>
            </Subscription>
          </DataSource>
        </DataSources>
        <WriteActions>
          <WriteAction ID="WA" TypeID="SystemCenter1!Microsoft.EnterpriseManagement.SystemCenter.Subscription.WindowsWorkflowTaskWriteAction">
            <Subscription>
              <WindowsWorkflowConfiguration>
                <AssemblyName>OfficeToAssignmentGroupIRWF</AssemblyName>
                <WorkflowTypeName>WorkflowAuthoring.OfficeToAssignmentGroupIRWF</WorkflowTypeName>
                <WorkflowParameters>
                  <WorkflowParameter Name="OfficeToAssignmentGroupIRScript_GUID" Type="string">$Data/BaseManagedEntityId$</WorkflowParameter>
                </WorkflowParameters>
                <RetryExceptions></RetryExceptions>
                <RetryDelaySeconds>60</RetryDelaySeconds>
                <MaximumRunningTimeSeconds>300</MaximumRunningTimeSeconds>
              </WindowsWorkflowConfiguration>
            </Subscription>
          </WriteAction>
        </WriteActions>
      </Rule>
    </Rules>
    <Tasks>
      <Task ID="OfficeToAssignmentGroupSRWF.WindowsPowerShellScript.64d30824_573f_4eab_8e10_936864f78bb8" Accessibility="Public" Enabled="true" Target="Windows!Microsoft.Windows.Computer" Timeout="300" Remotable="true">
        <Category>Notification</Category>
        <WriteAction ID="OfficeToAssignmentGroupSRWF.WindowsPowerShellScript.64d30824_573f_4eab_8e10_936864f78bb8.WA" TypeID="OfficeToAssignmentGroupSRWF.WindowsPowerShellScript.64d30824_573f_4eab_8e10_936864f78bb8.MT">
          <GUID></GUID>
        </WriteAction>
      </Task>
      <Task ID="OfficeToAssignmentGroupIRWF.WindowsPowerShellScript.1cc6771d_2022_4891_b61c_797ce410c8b0" Accessibility="Public" Enabled="true" Target="Windows!Microsoft.Windows.Computer" Timeout="300" Remotable="true">
        <Category>Notification</Category>
        <WriteAction ID="OfficeToAssignmentGroupIRWF.WindowsPowerShellScript.1cc6771d_2022_4891_b61c_797ce410c8b0.WA" TypeID="OfficeToAssignmentGroupIRWF.WindowsPowerShellScript.1cc6771d_2022_4891_b61c_797ce410c8b0.MT">
          <GUID></GUID>
        </WriteAction>
      </Task>
    </Tasks>
  </Monitoring>
  <LanguagePacks>
    <LanguagePack ID="ENU" IsDefault="true">
      <DisplayStrings>
        <DisplayString ElementID="Custom.SM.OfficeToAssignmentGroup.Workflows.MP">
          <Name>Custom.SM.OfficeToAssignmentGroup.Workflows.MP</Name>
        </DisplayString>
        <DisplayString ElementID="OfficeToAssignmentGroupSRWF">
          <Name>OfficeToAssignmentGroupSRWF</Name>
          <Description></Description>
        </DisplayString>
        <DisplayString ElementID="OfficeToAssignmentGroupSRWF.WindowsPowerShellScript.64d30824_573f_4eab_8e10_936864f78bb8">
          <Name>OfficeToAssignmentGroupSRWF.WindowsPowerShellScript.64d30824_573f_4eab_8e10_936864f78bb8</Name>
        </DisplayString>
        <DisplayString ElementID="OfficeToAssignmentGroupIRWF">
          <Name>OfficeToAssignmentGroupIRWF</Name>
          <Description>This workflows uses the affected users's office location to update the incident tier in the incident</Description>
        </DisplayString>
        <DisplayString ElementID="OfficeToAssignmentGroupIRWF" SubElementID="WA">
          <Name>This workflows uses the affected users's office location to update the incident tier in the incident</Name>
          <Description>This workflows uses the affected users's office location to update the incident tier in the incident</Description>
        </DisplayString>
        <DisplayString ElementID="OfficeToAssignmentGroupIRWF.WindowsPowerShellScript.1cc6771d_2022_4891_b61c_797ce410c8b0">
          <Name>OfficeToAssignmentGroupIRWF.WindowsPowerShellScript.1cc6771d_2022_4891_b61c_797ce410c8b0</Name>
        </DisplayString>
      </DisplayStrings>
    </LanguagePack>
  </LanguagePacks>
</ManagementPack>