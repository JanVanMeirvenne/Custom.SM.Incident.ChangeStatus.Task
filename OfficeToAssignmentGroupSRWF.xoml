<SequentialWorkflowActivity x:Class="WorkflowAuthoring.OfficeToAssignmentGroupSRWF" x:Name="OfficeToAssignmentGroupSRWF" xmlns:ns0="clr-namespace:Microsoft.ServiceManager.WorkflowAuthoring.ActivityLibrary;Assembly=Microsoft.ServiceManager.WorkflowAuthoring.ActivityLibrary, Version=7.0.5000.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" xmlns="http://schemas.microsoft.com/winfx/2006/xaml/workflow">
	<ns0:WindowsPowerShellScript Parameter="{x:Null}" SnapIns="{x:Null}" x:Name="OfficeToAssignmentGroupSRScript" PropertyToBind="{x:Null}" ScriptBody="get-module|Remove-Module -force&#xD;&#xA;Set-PSDebug -Strict&#xD;&#xA;[threading.thread]::CurrentThread.CurrentCulture = 'en-US'&#xD;&#xA;$Global:Log = &quot;&quot;&#xD;&#xA;function Log($Message){&#xD;&#xA;    if($Global:Log -eq &quot;&quot;){&#xD;&#xA;        New-EventLog -LogName 'Operations Manager' -Source 'Custom' -ErrorAction SilentlyContinue&#xD;&#xA;        $Global:Log = &quot;$Message`r`n&quot;&#xD;&#xA;    } else {&#xD;&#xA;        $Global:Log += &quot;$Message`r`n&quot;&#xD;&#xA;    } &#xD;&#xA;    Write-Output $Message&#xD;&#xA;}&#xD;&#xA;try{&#xD;&#xA;    Import-Module smlets -Force -Global&#xD;&#xA;    Log 'Office To Assignment Group Workflow (SR) Started'&#xD;&#xA;    &#xD;&#xA;    #$GUID = '734f814c-464a-5936-9184-51316f40fdeb'&#xD;&#xA;    Log &quot;Ticket GUID: $GUID&quot;&#xD;&#xA;    $Ticket = Get-SCSMObject -Id $GUID&#xD;&#xA;    Log &quot;Ticket ID: $($Ticket.Name)&quot;&#xD;&#xA;    $UserClass = Get-SCSMClass -Name 'System.Domain.User'&#xD;&#xA;&#xD;&#xA;    $Relationship = Get-SCSMRelationshipClass -Name 'System.WorkItemAffectedUser'&#xD;&#xA;&#xD;&#xA;    $AffectedUser = Get-SCSMRelatedObject -SMObject $Ticket -Relationship $Relationship&#xD;&#xA;    if($AffectedUser -ne $null){&#xD;&#xA;        Log &quot;Affected User: $($AffectedUser.DisplayName) with Office '$($AffectedUser.Office)'&quot;&#xD;&#xA;        $ConfigList = Get-SCSMTopLevelEnumeration -Name 'Custom.SM.OfficeToAssignmentGroup.MP.ENUM_Mapping'&#xD;&#xA;        $Items = Get-SCSMChildEnumeration -Depth 0 -Enumeration $ConfigList&#xD;&#xA;        $Item = $null&#xD;&#xA;        $Item = $Items|?{$_.DisplayName -eq $AffectedUser.Office}&#xD;&#xA;        if($Item -ne $null){&#xD;&#xA;            $SubItems = Get-SCSMChildEnumeration -Depth OneLevel -Enumeration $Item&#xD;&#xA;            $TierList = Get-SCSMTopLevelEnumeration -Name 'ServiceRequestSupportGroupEnum'&#xD;&#xA;            $TierItems = Get-SCSMChildEnumeration -Depth Recursive -Enumeration $TierList&#xD;&#xA;            $Target = $null&#xD;&#xA;            foreach($SubItem in $SubItems){&#xD;&#xA;     &#xD;&#xA;                if($Target -eq $null){&#xD;&#xA;    &#xD;&#xA;                    $Target = $TierItems|?{$_.DisplayName -eq $SubItem.DisplayName}&#xD;&#xA;                }&#xD;&#xA;            }&#xD;&#xA;    &#xD;&#xA;            if($Target -ne $null){&#xD;&#xA;                Log &quot;Mapping found: $($Item.DisplayName) --&gt; $($Target.DisplayName)&quot;&#xD;&#xA;&#xD;&#xA;                Set-SCSMObject -SMObject $Ticket -PropertyHashtable @{'SupportGroup'=$Target.DisplayName}&#xD;&#xA;                Log &quot;Ticket Support Group Set to $($Target.DisplayName)&quot;&#xD;&#xA;            } else {&#xD;&#xA;                Log &quot;No mapping found&quot;&#xD;&#xA;            }&#xD;&#xA;        } else { Log &quot;No mapping found&quot; }&#xD;&#xA;    } else { Log &quot;No affected user found&quot;}&#xD;&#xA;} catch {&#xD;&#xA;    Log &quot;Error: $_&quot;&#xD;&#xA;} finally {&#xD;&#xA;    Log &quot;Workflow ended&quot;&#xD;&#xA;    Write-EventLog -LogName 'Operations Manager' -Source 'Custom' -EntryType Information -Message $Global:Log -EventId 0&#xD;&#xA;&#xD;&#xA;    Get-Module|Remove-Module -Force&#xD;&#xA;    &#xD;&#xA;}" TaskID="OfficeToAssignmentGroupSRWF.WindowsPowerShellScript.64d30824_573f_4eab_8e10_936864f78bb8" ScriptName="{x:Null}">
		<ns0:WindowsPowerShellScript.Parameters>
			<x:Array Type="{x:Type p7:ActivityParameter}" xmlns:p7="clr-namespace:Microsoft.ServiceManager.WorkflowAuthoring.Common;Assembly=Microsoft.ServiceManager.WorkflowAuthoring.Common, Version=7.0.5000.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35">
				<ns1:ActivityParameter Key="GUID" BindPath="{ActivityBind OfficeToAssignmentGroupSRWF,Path=OfficeToAssignmentGroupSRScript_GUID}" Value="Activity=OfficeToAssignmentGroupSRWF, Path=OfficeToAssignmentGroupSRScript_GUID" xmlns:ns1="clr-namespace:Microsoft.ServiceManager.WorkflowAuthoring.Common;Assembly=Microsoft.ServiceManager.WorkflowAuthoring.Common, Version=7.0.5000.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35" />
			</x:Array>
		</ns0:WindowsPowerShellScript.Parameters>
	</ns0:WindowsPowerShellScript>
</SequentialWorkflowActivity>